<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>飞机大战 · 手机竖屏触控版</title>
  <style>
    :root { --ui-bg: rgba(255,255,255,.12); --ui-bg-strong: rgba(255,255,255,.18); }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: #000; color: #e7e7e7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "PingFang SC", "Microsoft YaHei", sans-serif; }
    .wrap { position: relative; height: 100vh; max-height: 100dvh; overflow: hidden; }
    #game { position: absolute; inset: 0; width: 100%; height: 100%; display: block; touch-action: none; }

    /* HUD */
    .hud { position: absolute; left: 0; right: 0; top: 0; padding: 8px 12px; pointer-events: none; display: flex; justify-content: space-between; gap: 8px; }
    .chip { background: var(--ui-bg); border-radius: 999px; padding: 6px 10px; backdrop-filter: blur(6px); font-size: 12px; }

    /* 控件区域（手机触控） */
    .controls { position: absolute; inset: 0; pointer-events: none; }
    .leftpad { position: absolute; left: 10px; bottom: 12px; width: 160px; height: 160px; display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 8px; pointer-events: none; }
    .btn { pointer-events: auto; display:flex; align-items:center; justify-content:center; border-radius: 16px; background: var(--ui-bg); backdrop-filter: blur(6px); color:#fff; font-weight:600; user-select:none; -webkit-user-select:none; }
    .btn:active { background: var(--ui-bg-strong); }
    .btn.small { font-size: 14px; }

    .up { grid-column: 2 / 3; grid-row: 1 / 2; }
    .left { grid-column: 1 / 2; grid-row: 2 / 3; }
    .right{ grid-column: 3 / 4; grid-row: 2 / 3; }
    .down { grid-column: 2 / 3; grid-row: 3 / 4; }

    .rightpad { position: absolute; right: 10px; bottom: 12px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: none; }
    .fire { width: 110px; height: 110px; border-radius: 999px; font-size: 18px; }
    .row { display: flex; gap: 10px; }

    .pill { width: 84px; height: 42px; border-radius: 999px; font-size: 14px; }

    /* 横屏提示（可选） */
    .rotate-hint { position: absolute; inset: 0; display:none; align-items:center; justify-content:center; background: #000; color:#fff; font-size:16px; }
    @media (orientation: landscape) and (max-width: 900px) {
      .rotate-hint { display:flex; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game"></canvas>

    <div class="hud">
      <div class="chip">触控方向键 + 射击｜也支持实体键：WASD / 空格</div>
      <div class="chip">P 暂停 · R 重开 · 击中震动 · 受击彩色贴花</div>
    </div>

    <div class="controls" aria-hidden="false">
      <div class="leftpad">
        <div class="btn up small"    data-key="w">▲</div>
        <div class="btn left small"  data-key="a">◀</div>
        <div class="btn right small" data-key="d">▶</div>
        <div class="btn down small"  data-key="s">▼</div>
      </div>
      <div class="rightpad">
        <div class="btn fire" data-key=" ">射击</div>
        <div class="row">
          <div class="btn pill" data-key="p">暂停</div>
          <div class="btn pill" data-key="r">重开</div>
        </div>
      </div>
    </div>

    <div class="rotate-hint">请旋转回竖屏以获得最佳体验</div>
  </div>

<script>
(function(){
  // 画布 & 尺寸
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var DPR = Math.min(window.devicePixelRatio || 1, 2);
  var W=720, H=1280; // 竖屏基准
  function resize(){
    var rect = canvas.getBoundingClientRect();
    var w = Math.floor(rect.width * DPR);
    var h = Math.floor(rect.height * DPR);
    canvas.width = w; canvas.height = h; W = w; H = h;
    // 初始位置随分辨率调整
    player.x = W*0.5; player.y = H*0.8;
  }
  // 初始立即设置 CSS 尺寸为父容器
  function fit(){ canvas.style.width='100%'; canvas.style.height='100%'; resize(); }
  fit(); window.addEventListener('resize', resize);

  // 状态
  var running=true, score=0, hp=5, t=0, prev=0, shake=0;
  var maxShake=22, shakeDecay=0.92;
  var keys = Object.create(null);
  var player = { x:W*0.5, y:H*0.8, w:40, h:48, vx:0, vy:0 };
  var bullets=[], enemies=[], enemyBullets=[], particles=[], decals=[];
  var lastSpawn=0, lastShoot=0;

  // 参数（根据竖屏设备做微调）
  var playerSpeed = 520;      // 竖屏手感稍快
  var bulletSpeed = 900;
  var enemyMinSpeed = 120;    // 更多纵向空间，提升敌速
  var enemyMaxSpeed = 280;
  var enemySpawnInterval = 0.75;
  var shootCooldown = 0.11;

  // 工具
  function rand(a,b){ return a + Math.random()*(b-a); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function addParticle(x,y,count,power,hueBase){ count=count==null?18:count; power=power==null?1:power; hueBase=hueBase==null?180:hueBase; for(var i=0;i<count;i++){ var ang=Math.random()*Math.PI*2; var spd=rand(80,360)*power; particles.push({x:x,y:y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life:rand(0.4,0.9),age:0,size:rand(2,6),hue:hueBase+rand(-30,30),glow:rand(0.6,1.2),trail:false}); } }
  function addTrail(x,y,hue){ if(hue==null) hue=200; particles.push({x:x,y:y,vx:0,vy:0,life:0.25,age:0,size:6,hue:hue,glow:1.2,trail:true}); }
  function addDecal(x,y){ decals.push({x:x,y:y,r:rand(120,220),life:1.2,age:0,hue:rand(0,360)}); }

  // 键盘（兼容物理键）
  window.addEventListener('keydown', function(e){ var k=(e.key||'').toLowerCase(); keys[k]=true; if(e.key===' ') e.preventDefault(); if(k==='p') toggleRun(); if(k==='r') restart(); });
  window.addEventListener('keyup',   function(e){ var k=(e.key||'').toLowerCase(); keys[k]=false; });

  // 触控按钮
  function bindButton(el){
    var key = el.getAttribute('data-key');
    var press = function(ev){ ev.preventDefault(); keys[key]=true; if(key==='p') toggleRun(); if(key==='r') restart(); };
    var release = function(ev){ ev.preventDefault(); if(key!=='p' && key!=='r') keys[key]=false; };
    el.addEventListener('touchstart', press, {passive:false});
    el.addEventListener('touchend',   release, {passive:false});
    el.addEventListener('touchcancel',release, {passive:false});
    el.addEventListener('mousedown',  press);
    el.addEventListener('mouseup',    release);
    el.addEventListener('mouseleave', release);
  }
  [].forEach.call(document.querySelectorAll('.btn'), bindButton);

  function toggleRun(){ running=!running; }
  function restart(){ bullets.length=0; enemies.length=0; enemyBullets.length=0; particles.length=0; decals.length=0; t=0; lastSpawn=0; lastShoot=0; shake=0; score=0; hp=5; running=true; player.x=W*0.5; player.y=H*0.8; }

  // 主循环
  function loop(now){ if(!prev) prev=now; var dt=Math.min((now-prev)/1000, 0.033); prev=now; if(running){ update(dt); } draw(dt); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  function update(dt){
    t+=dt;
    // 移动
    var left=keys['a'], right=keys['d'], up=keys['w'], down=keys['s'], space=keys[' '];
    player.vx=(right?1:0)-(left?1:0); player.vy=(down?1:0)-(up?1:0);
    var len=Math.sqrt(player.vx*player.vx+player.vy*player.vy)||1;
    player.x+= (player.vx/len)*playerSpeed*dt*DPR; player.y+= (player.vy/len)*playerSpeed*dt*DPR;
    player.x=clamp(player.x, 40, W-40); player.y=clamp(player.y, 60, H-60);
    if((player.vx||player.vy) && Math.random()<0.8) addTrail(player.x, player.y+16*DPR, 190+Math.sin(t*6)*40);

    // 发射
    if(space && t-lastShoot>shootCooldown){ lastShoot=t; bullets.push({x:player.x, y:player.y-26*DPR, v:-bulletSpeed*DPR}); addParticle(player.x, player.y-26*DPR, 10, 0.5, 190); }

    // 子弹
    for(var i=0;i<bullets.length;i++){ bullets[i].y += bullets[i].v*dt; }
    for(var i=bullets.length-1;i>=0;i--){ if(bullets[i].y<-50) bullets.splice(i,1); }

    // 敌人生成
    if(t-lastSpawn>enemySpawnInterval){ lastSpawn=t; var ex=rand(60,W-60), vy=rand(enemyMinSpeed,enemyMaxSpeed)*DPR, vx=rand(-60,60)*DPR; enemies.push({x:ex,y:-30,vx:vx,vy:vy,hp:3,ttl:12,wave:Math.random()*Math.PI*2}); }

    // 敌人逻辑
    for(var i=0;i<enemies.length;i++){ var e=enemies[i]; e.wave+=dt*3; e.x += (e.vx + Math.sin(e.wave)*80*DPR)*dt; e.y += e.vy*dt; e.ttl-=dt; if(Math.random()<0.02){ var ang=Math.atan2(player.y-e.y, player.x-e.x); var sp=rand(180,260)*DPR; enemyBullets.push({x:e.x,y:e.y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp}); } }
    for(var i=enemies.length-1;i>=0;i--){ if(enemies[i].y>H+60 || enemies[i].ttl<=0) enemies.splice(i,1); }

    // 敌弹
    for(var i=0;i<enemyBullets.length;i++){ enemyBullets[i].x += enemyBullets[i].vx*dt; enemyBullets[i].y += enemyBullets[i].vy*dt; }
    for(var i=enemyBullets.length-1;i>=0;i--){ var b=enemyBullets[i]; if(b.x<-40||b.x>W+40||b.y>H+40) enemyBullets.splice(i,1); }

    // 碰撞：我方弹→敌
    for(var i=bullets.length-1;i>=0;i--){ var b=bullets[i]; for(var j=enemies.length-1;j>=0;j--){ var e=enemies[j]; if(Math.abs(b.x-e.x)<28*DPR && Math.abs(b.y-e.y)<28*DPR){ bullets.splice(i,1); e.hp-=1; addParticle(e.x,e.y,24,1.1,40+Math.random()*40); shake=clamp(shake+9,0,maxShake); if(e.hp<=0){ addParticle(e.x,e.y,50,1.4,10); enemies.splice(j,1); score+=100; } break; } } }

    // 碰撞：敌弹/敌机→我
    function playerHit(){ if(hp<=0) return; hp=Math.max(0,hp-1); addDecal(player.x,player.y); addParticle(player.x,player.y,42,1.2,320); shake=clamp(shake+14,0,maxShake); }
    for(var i=enemyBullets.length-1;i>=0;i--){ var eb=enemyBullets[i]; if(Math.abs(eb.x-player.x)<26*DPR && Math.abs(eb.y-player.y)<26*DPR){ enemyBullets.splice(i,1); playerHit(); } }
    for(var j=enemies.length-1;j>=0;j--){ var e2=enemies[j]; if(Math.abs(e2.x-player.x)<30*DPR && Math.abs(e2.y-player.y)<34*DPR){ enemies.splice(j,1); playerHit(); } }

    // 粒子 & 贴花 & 震动
    for(var i=particles.length-1;i>=0;i--){ var p=particles[i]; p.age+=dt; p.x+=p.vx?p.vx*dt:0; p.y+=p.vy?p.vy*dt:0; if(p.age>=p.life) particles.splice(i,1); }
    for(var i=decals.length-1;i>=0;i--){ var d=decals[i]; d.age+=dt; if(d.age>=d.life) decals.splice(i,1); }
    shake *= shakeDecay;
  }

  function draw(dt){
    // 背景
    var g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'hsl(' + ((t*20)%360) + ' 80% 6%)'); g.addColorStop(1,'hsl(' + ((t*20+120)%360) + ' 90% 10%)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

    // 震动
    ctx.save(); var sx=(Math.random()*2-1)*shake, sy=(Math.random()*2-1)*shake; ctx.translate(sx,sy);

    // 星点
    ctx.globalAlpha=0.7; for(var i=0;i<90;i++){ var x=((i*97.3+t*60)%W), y=(i*53.7)%H; ctx.fillStyle='hsl(' + ((i*23+t*30)%360) + ' 70% 60%)'; ctx.fillRect(x,y,2,2); } ctx.globalAlpha=1;

    // 粒子（加亮）
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(var i=0;i<particles.length;i++){ var p=particles[i], a=1-p.age/p.life, r=p.size; var rg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r*4); rg.addColorStop(0,'hsla(' + p.hue + ' 100% 60% / ' + (0.9*a) + ')'); rg.addColorStop(1,'hsla(' + p.hue + ' 100% 50% / 0)'); ctx.fillStyle=rg; ctx.beginPath(); ctx.arc(p.x,p.y,r*4,0,Math.PI*2); ctx.fill(); }
    ctx.restore();

    // 敌人
    for(var i=0;i<enemies.length;i++) drawEnemy(enemies[i].x, enemies[i].y);

    // 敌弹
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(var i=0;i<enemyBullets.length;i++){ var b=enemyBullets[i]; var rg2=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,10); rg2.addColorStop(0,'rgba(255,180,180,0.9)'); rg2.addColorStop(1,'rgba(255,0,0,0)'); ctx.fillStyle=rg2; ctx.beginPath(); ctx.arc(b.x,b.y,10,0,Math.PI*2); ctx.fill(); }
    ctx.restore();

    // 我方子弹
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(var i=0;i<bullets.length;i++){ var bb=bullets[i]; var lg=ctx.createLinearGradient(bb.x,bb.y-12,bb.x,bb.y+12); lg.addColorStop(0,'rgba(120,200,255,0)'); lg.addColorStop(0.5,'rgba(120,220,255,1)'); lg.addColorStop(1,'rgba(120,200,255,0)'); ctx.strokeStyle=lg; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(bb.x,bb.y+12); ctx.lineTo(bb.x,bb.y-12); ctx.stroke(); }
    ctx.restore();

    // 玩家
    drawPlayer(player.x, player.y);

    // 贴花
    ctx.save(); ctx.globalCompositeOperation='screen';
    for(var i=0;i<decals.length;i++){ var d=decals[i], a=1-d.age/d.life, r=d.r*(0.9+0.2*Math.sin((t+d.hue)*2)); var rd=ctx.createRadialGradient(d.x,d.y,0,d.x,d.y,r); rd.addColorStop(0,'hsla(' + d.hue + ' 100% 60% / ' + (0.35*a) + ')'); rd.addColorStop(0.6,'hsla(' + ((d.hue+120)%360) + ' 100% 55% / ' + (0.25*a) + ')'); rd.addColorStop(1,'hsla(' + ((d.hue+240)%360) + ' 100% 50% / 0)'); ctx.fillStyle=rd; ctx.beginPath(); ctx.arc(d.x,d.y,r,0,Math.PI*2); ctx.fill(); }
    ctx.restore();

    ctx.restore(); // 结束震动

    drawHUD();
  }

  function roundShip(cx,cy,w,h){ ctx.beginPath(); var r=Math.min(w,h)*0.35; ctx.moveTo(cx-w*0.3,cy-h*0.5); ctx.quadraticCurveTo(cx,cy-h*0.8,cx+w*0.3,cy-h*0.5); ctx.lineTo(cx+w*0.35,cy+h*0.3); ctx.quadraticCurveTo(cx,cy+h*0.55,cx-w*0.35,cy+h*0.3); ctx.closePath(); }
  function drawPlayer(x,y){ var time=t; ctx.save(); ctx.translate(x,y); var pulse=0.6+Math.sin(time*8)*0.4; var bg=ctx.createLinearGradient(0,-30,0,30); bg.addColorStop(0,'hsl(' + (200+Math.sin(time*2)*20) + ' 90% ' + (40+pulse*20) + '%)'); bg.addColorStop(1,'hsl(' + (220+Math.cos(time*2)*20) + ' 90% 25%)'); ctx.fillStyle=bg; roundShip(0,0,40,48); ctx.fill(); ctx.globalCompositeOperation='lighter'; var wing=ctx.createLinearGradient(-35,0,35,0); wing.addColorStop(0,'rgba(0,255,255,0)'); wing.addColorStop(0.5,'rgba(0,255,255,0.6)'); wing.addColorStop(1,'rgba(0,255,255,0)'); ctx.strokeStyle=wing; ctx.lineWidth=5; ctx.beginPath(); ctx.moveTo(-35,4); ctx.lineTo(35,4); ctx.stroke(); for(var i=0;i<3;i++){ var len=24+i*10+Math.sin(time*10+i)*6; var g=ctx.createLinearGradient(0,12,0,12+len); g.addColorStop(0,'rgba(80,220,255,0.9)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.moveTo(-6+i*3,12); ctx.lineTo(6+i*3,12); ctx.lineTo(0+i*3,12+len); ctx.closePath(); ctx.fill(); } ctx.restore(); }
  function drawEnemy(x,y){ ctx.save(); ctx.translate(x,y); var g=ctx.createLinearGradient(0,-20,0,20); g.addColorStop(0,'hsl(10 90% 55%)'); g.addColorStop(1,'hsl(0 90% 30%)'); ctx.fillStyle=g; roundShip(0,0,34,34); ctx.fill(); ctx.globalCompositeOperation='lighter'; var halo=ctx.createRadialGradient(0,0,0,0,0,40); halo.addColorStop(0,'rgba(255,120,120,0.5)'); halo.addColorStop(1,'rgba(255,0,0,0)'); ctx.fillStyle=halo; ctx.beginPath(); ctx.arc(0,0,40,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  function drawHUD(){ var g=ctx.createLinearGradient(0,0,0,120); g.addColorStop(0,'rgba(255,255,255,0.12)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,120); ctx.font=(28*DPR)+'px ui-monospace, SFMono-Regular, Menlo, monospace'; ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText('SCORE: '+score, 20*DPR, 20*DPR); for(var i=0;i<hp;i++){ var x=W-20*DPR - i*36*DPR, y=34*DPR; ctx.save(); ctx.translate(x,y); ctx.globalCompositeOperation='lighter'; var halo=ctx.createRadialGradient(0,0,0,0,0,18); halo.addColorStop(0,'rgba(120,255,200,0.9)'); halo.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=halo; ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill(); ctx.restore(); } if(hp<=0){ ctx.font=(56*DPR)+'px Inter, system-ui, sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.fillText('GAME OVER', W/2, H/2); ctx.font=(20*DPR)+'px Inter'; ctx.fillText('点 〈重开〉 或按 R', W/2, H/2 + 48*DPR); }
  }
})();
</script>
</body>
</html>
