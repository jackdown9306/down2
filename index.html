<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>飞机大战 - 五关触屏豪华版（Boss：异形/翼龙/霸王龙/机甲/终极）</title>
<style>
  :root{--ui:rgba(255,255,255,0.08);--ui-2:rgba(255,255,255,0.16)}
  html,body{height:100%;margin:0;background:#000;touch-action:none;-webkit-user-select:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Microsoft YaHei',sans-serif}
  #game{display:block;width:100vw;height:100vh}
  /* 左下 虚拟摇杆 */
  .joy-wrap{position:fixed;left:12px;bottom:12px;width:140px;height:140px;border-radius:999px;background:var(--ui);display:flex;align-items:center;justify-content:center;z-index:1000}
  .joy-base{position:relative;width:90%;height:90%;border-radius:999px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
  .joy-knob{position:absolute;width:46px;height:46px;border-radius:999px;background:linear-gradient(180deg,#08f,#0ff);box-shadow:0 6px 18px rgba(0,200,255,0.25);left:50%;top:50%;transform:translate(-50%,-50%)}

  /* 右下按键 */
  .fire-btn{position:fixed;right:14px;bottom:18px;width:86px;height:86px;border-radius:999px;background:radial-gradient(circle,#ffec6a,#ff6a6a);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;z-index:1000;box-shadow:0 12px 24px rgba(255,100,100,0.18)}
  .aux-row{position:fixed;right:14px;bottom:120px;display:flex;flex-direction:column;gap:10px;z-index:1000}
  .aux{width:72px;height:42px;background:var(--ui);border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:600}

  /* 顶部 UI */
  .hud{position:fixed;left:12px;top:12px;z-index:1000;display:flex;gap:12px}
  .badge{background:var(--ui);padding:8px 12px;border-radius:999px}
  .power-ind{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:1000}

  /* Boss 血条 */
  .bossbar{position:fixed;left:50%;top:52px;transform:translateX(-50%);width:80%;height:16px;background:rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;z-index:1000}
  .bossbar-inner{height:100%;background:linear-gradient(90deg,#ff4d4d,#ffb347);width:0%}

  /* Level title */
  .level-title{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:1001;padding:10px 18px;border-radius:12px;background:rgba(0,0,0,0.6);font-weight:800;letter-spacing:2px;display:none}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud">
  <div class="badge" id="score">SCORE: 0</div>
  <div class="badge" id="lives">LIVES: 5</div>
  <div class="badge" id="levelBadge">LEVEL: 1</div>
</div>
<div class="power-ind" id="powerIndicator"></div>
<div class="bossbar" id="bossbar" style="display:none"><div class="bossbar-inner" id="bossbarInner"></div></div>
<div class="level-title" id="levelTitle">LEVEL 1</div>

<div class="joy-wrap" id="joyWrap" aria-hidden="false"><div class="joy-base" id="joyBase"><div class="joy-knob" id="joyKnob"></div></div></div>
<div class="fire-btn" id="fireBtn">FIRE</div>
<div class="aux-row">
  <div class="aux" id="btnSpread">散弹</div>
  <div class="aux" id="btnMissile">导弹</div>
</div>

<script>
/* ====== 五关飞机大战 - 单文件 ======
   - 五关 Boss: 1. Alien (异形) 2. Pteranodon (翼龙)
                3. T-Rex (霸王龙) 4. MechaDino (机甲恐龙) 5. Overlord (终极异形)
   - 每击败 Boss -> 进入下一关，且小怪行为随关卡改变
   - 左下圆形摇杆，右下长按开火，道具支持
*/

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth, H = canvas.height = innerHeight;
window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; });

// GAME STATE
let score = 0, lives = 5, time = 0;
let level = 1; // 1..5
let boss = null; // boss object when present
let enemies = [], particles = [], powerups = [];
let shake = 0;
let showLevelTimer = 0;

// PLAYER
const player = { x: W/2, y: H*0.78, r: 28, speed: 520, bullets: [], hp: 3 };

// POWER
let power = { mode:'single', timer:0, missileAmmo:0 };

// JOYSTICK
const joyBase = document.getElementById('joyBase');
const joyKnob = document.getElementById('joyKnob');
let joyActive=false, joyId=null, joyPos={x:0,y:0};
const maxJoy = 46;
function joyToVector(){ return { x: joyPos.x / maxJoy, y: joyPos.y / maxJoy }; }

// INPUT FIRE
let firing=false, fireInterval=null;
function startFiring(){ if(firing) return; firing=true; shoot(); fireInterval = setInterval(shoot, power.mode==='single'?180:(power.mode==='spread'?320:140)); }
function stopFiring(){ firing=false; if(fireInterval){ clearInterval(fireInterval); fireInterval=null; } }

function shoot(){ if(power.mode==='laser'){ if(power.missileAmmo<=0) return; power.missileAmmo--; }
  if(power.mode==='single'){ player.bullets.push({x:player.x,y:player.y-player.r-8,vx:0,vy:-1100,type:'bullet'}); }
  else if(power.mode==='spread'){ const offs=[-0.32,-0.12,0,0.12,0.32]; offs.forEach(o=> player.bullets.push({x:player.x+o*10,y:player.y-player.r-8,vx:o*800,vy:-920,type:'bullet'})); }
  else if(power.mode==='laser'){ player.bullets.push({x:player.x,y:player.y-player.r-20,vx:0,vy:-1400,type:'laser'}); }
}

// UTIL
function rand(a,b){ return a + Math.random()*(b-a); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// enemy spawn logic depends on level
function spawnEnemyVariant(){
  // variant depends on level
  if(level===1){ // simple grunts
    enemies.push({x:rand(40,W-40),y:-40,r:18,vy:rand(100,160),hp:1,pattern:'sine',t:0});
  } else if(level===2){ // faster, some dive
    enemies.push({x:rand(40,W-40),y:-40,r:20,vy:rand(140,220),hp:1,pattern:'dive',t:0});
  } else if(level===3){ // tougher packs
    enemies.push({x:rand(40,W-40),y:-40,r:22,vy:rand(120,200),hp:2,pattern:'sine',t:0});
  } else if(level===4){ // machine enemies that shoot
    enemies.push({x:rand(40,W-40),y:-40,r:20,vy:rand(120,200),hp:2,pattern:'shooter',t:0,shootCooldown:rand(0.6,1.6)});
  } else { // level 5 chaotic
    enemies.push({x:rand(40,W-40),y:-40,r:16,vy:rand(160,280),hp:1,pattern:'zigzag',t:0});
  }
}

function spawnPower(x,y){ const t = Math.random()<0.5?'spread':'laser'; powerups.push({x,y,r:18,type:t,ttl:9}); }

// Boss definitions (5 bosses)
const BOSS_DEFS = [
  { id:1, name:'Alien', type:'alien', hp:80, color:'#a2ffb8', behavior:'alpha' },
  { id:2, name:'Pteranodon', type:'ptera', hp:120, color:'#9be0ff', behavior:'ptera' },
  { id:3, name:'T-Rex', type:'trex', hp:180, color:'#ffb4a2', behavior:'trex' },
  { id:4, name:'MechaDino', type:'mech', hp:240, color:'#ffd66b', behavior:'mech' },
  { id:5, name:'Overlord', type:'overlord', hp:400, color:'#ffa0ff', behavior:'overlord' }
];

function spawnBossByLevel(lv){ const def = BOSS_DEFS[lv-1]; if(!def) return; boss = { ...def, hp:def.hp, maxHp:def.hp, x:W/2, y:-220, t:0, phase:0 }; document.getElementById('bossbar').style.display='block'; document.getElementById('levelBadge').textContent = 'BOSS: ' + def.name; }

// joystick handlers
joyBase.addEventListener('touchstart', e=>{ e.preventDefault(); const t = e.changedTouches[0]; joyActive=true; joyId=t.identifier; handleJoyFromTouch(t); });
joyBase.addEventListener('touchmove', e=>{ e.preventDefault(); if(!joyActive) return; for(let i=0;i<e.changedTouches.length;i++){ const t=e.changedTouches[i]; if(t.identifier===joyId){ handleJoyFromTouch(t); break; } } });
joyBase.addEventListener('touchend', e=>{ for(let i=0;i<e.changedTouches.length;i++){ if(e.changedTouches[i].identifier===joyId){ joyActive=false; joyId=null; joyPos.x=0; joyPos.y=0; updateKnob(); break; } } });

function handleJoyFromTouch(t){ const rect = joyBase.getBoundingClientRect(); const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2; let dx = (t.clientX - cx); let dy = (t.clientY - cy); const dist = Math.hypot(dx,dy); const max = (rect.width/2) - 12; if(dist>max){ dx = dx*(max/dist); dy = dy*(max/dist); } joyPos.x = dx; joyPos.y = dy; updateKnob(); }
function updateKnob(){ joyKnob.style.transform = `translate(${joyPos.x}px, ${joyPos.y}px)`; }

// fire button
const fireBtn = document.getElementById('fireBtn');
fireBtn.addEventListener('touchstart', e=>{ e.preventDefault(); startFiring(); });
fireBtn.addEventListener('touchend', e=>{ e.preventDefault(); stopFiring(); });
fireBtn.addEventListener('mousedown', e=>{ e.preventDefault(); startFiring(); });
fireBtn.addEventListener('mouseup', e=>{ e.preventDefault(); stopFiring(); });

// aux buttons
document.getElementById('btnSpread').addEventListener('click', ()=>{ activatePower('spread',12); });
document.getElementById('btnMissile').addEventListener('click', ()=>{ activatePower('laser',18,4); });

function activatePower(mode, seconds, ammo){ power.mode = mode; power.timer = seconds; power.missileAmmo = ammo||power.missileAmmo; updatePowerUI(); }
function updatePowerUI(){ const el = document.getElementById('powerIndicator'); if(power.mode === 'single' || power.timer<=0) el.innerHTML = ''; else el.innerHTML = `<div style="padding:6px 12px;background:var(--ui);border-radius:999px;font-weight:700">${power.mode.toUpperCase()} ${power.mode==='laser'?(' x'+power.missileAmmo):''}</div>`; }

// collisions and update
function update(dt){ time += dt; // joystick movement
  const v = joyToVector(); player.x += v.x * player.speed * dt; player.y += v.y * player.speed * dt;
  player.x = clamp(player.x, 40, W-40); player.y = clamp(player.y, H*0.45, H-40);

  // bullets
  for(let i=player.bullets.length-1;i>=0;i--){ const b=player.bullets[i]; b.x += b.vx*dt; b.y += b.vy*dt; b.t = (b.t||0) + dt; if(b.y < -80 || b.x < -200 || b.x > W+200) player.bullets.splice(i,1); }

  // enemies movement
  enemies.forEach(e=>{ e.t = (e.t||0) + dt; if(e.pattern==='sine'){ e.y += e.vy*dt; e.x += Math.sin(e.t*2 + e.wave)*40*dt; }
    else if(e.pattern==='dive'){ e.y += e.vy*dt; if(Math.random() < 0.002) e.vy += 80; }
    else if(e.pattern==='zigzag'){ e.y += e.vy*dt; e.x += Math.sin(e.t*6)*80*dt; }
    else if(e.pattern==='shooter'){ e.y += e.vy*dt; e.since = (e.since||0) + dt; if(e.since > e.shootCooldown){ e.since=0; // shoot downward
        enemies.push({x:e.x,y:e.y+12,r:6,vy:rand(260,380),hp:1,pattern:'bullet',t:0}); }
    }
  });

  // powerups
  for(let i=powerups.length-1;i>=0;i--){ const p=powerups[i]; p.ttl -= dt; if(p.ttl<=0) powerups.splice(i,1); else if(Math.hypot(p.x-player.x,p.y-player.y) < p.r+player.r){ activatePower(p.type, p.type==='spread'?12:16, p.type==='laser'?3:0); powerups.splice(i,1); } }

  // bullets vs enemies
  for(let ei=enemies.length-1; ei>=0; ei--){ const e=enemies[ei]; for(let bi=player.bullets.length-1; bi>=0; bi--){ const b=player.bullets[bi]; // simple AABB-ish
      if(b.x > e.x - e.r && b.x < e.x + e.r && b.y > e.y - e.r && b.y < e.y + e.r){ // hit
        player.bullets.splice(bi,1);
        e.hp = (e.hp||1) - (b.type==='laser'?3:1);
        createExplosion(e.x, e.y);
        if(e.hp <= 0){ enemies.splice(ei,1); score += (level*10 + 40); if(Math.random() < 0.12) spawnPower(e.x,e.y); }
        break;
      }
    }
  }

  // bullets vs boss
  if(boss){ boss.t += dt; if(boss.y < 80) boss.y += 40*dt; else {
    // behavior by boss.behavior
    if(boss.behavior === 'alpha'){ boss.x = W/2 + Math.sin(boss.t*0.6)*(W*0.22); if(Math.random()<0.015) enemies.push({x:boss.x+rand(-80,80),y:boss.y+60,r:10,vy:rand(220,340),hp:1,pattern:'bullet'}); }
    else if(boss.behavior === 'ptera'){ boss.x = W/2 + Math.sin(boss.t*0.9)*(W*0.36); if(Math.random()<0.02){ // spawn dive pack
        for(let i=0;i<3;i++) enemies.push({x:boss.x + i*40 - 40,y:boss.y+60,r:16,vy:rand(300,420),hp:1,pattern:'dive'});
      } }
    else if(boss.behavior === 'trex'){ boss.x = W/2 + Math.cos(boss.t*0.5)*(W*0.15); if(Math.random()<0.03){ // scatter bombs
        for(let i=0;i<6;i++) enemies.push({x:boss.x + rand(-140,140), y:boss.y+40, r:12, vy: rand(200,360), hp:1, pattern:'zigzag'});
      } }
    else if(boss.behavior === 'mech'){ boss.x = W/2 + Math.sin(boss.t*0.7)*(W*0.28); if(Math.random()<0.04){ enemies.push({x:boss.x + rand(-60,60), y:boss.y+80, r:14, vy: rand(280,420), hp:1, pattern:'shooter', shootCooldown: rand(0.4,1.2)}); } }
    else if(boss.behavior === 'overlord'){ boss.x = W/2 + Math.sin(boss.t*1.1)*(W*0.36); if(Math.random()<0.06){ // heavy bullet rain
        for(let a=0;a<8;a++) enemies.push({x:boss.x + rand(-200,200), y:boss.y+40, r:10, vy:rand(300,520), hp:1, pattern:'bullet'});
      } }

    // boss hurt by bullets
    for(let bi=player.bullets.length-1; bi>=0; bi--){ const b = player.bullets[bi]; if(b.x > boss.x - 120 && b.x < boss.x + 120 && b.y > boss.y - 80 && b.y < boss.y + 80){ player.bullets.splice(bi,1); boss.hp -= (b.type==='laser'?6:1); createExplosion(b.x,b.y); shake = 10; }
    }
    if(boss.hp <= 0){ // boss defeated
      createExplosion(boss.x,boss.y); score += 2000 + level*500; boss = null; document.getElementById('bossbar').style.display='none'; advanceLevel(); }
  }}

  // spawn ambient enemies when no boss
  if(!boss){ if(enemies.length < clamp(5 + level*2, 4, 18) && Math.random() < 0.025) spawnEnemyVariant(); }

  // level triggers: if time hits thresholds spawn boss
  if(!boss){ if(level===1 && time > 18){ spawnBossByLevel(1); showLevelTitle('LEVEL 1 - ALIEN'); }
               else if(level===2 && time > 42){ spawnBossByLevel(2); showLevelTitle('LEVEL 2 - PTERANODON'); }
               else if(level===3 && time > 80){ spawnBossByLevel(3); showLevelTitle('LEVEL 3 - T-REX'); }
               else if(level===4 && time > 130){ spawnBossByLevel(4); showLevelTitle('LEVEL 4 - MECHADINO'); }
               else if(level===5 && time > 190){ spawnBossByLevel(5); showLevelTitle('LEVEL 5 - OVERLORD'); } }

  // power timer
  if(power.timer > 0){ power.timer -= dt; if(power.timer <= 0){ power.mode='single'; power.missileAmmo=0; updatePowerUI(); } }

  // particles
  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x += p.vx*dt; p.y += p.vy*dt; p.alpha -= dt*1.2; if(p.alpha <=0) particles.splice(i,1); }

  // update UI
  document.getElementById('score').textContent = 'SCORE: ' + Math.floor(score);
  document.getElementById('lives').textContent = 'LIVES: ' + lives;
  document.getElementById('levelBadge').textContent = 'LEVEL: ' + level;
  if(boss){ const pct = clamp(boss.hp / boss.maxHp * 100, 0, 100); document.getElementById('bossbarInner').style.width = pct + '%'; document.getElementById('bossbar').style.display='block'; }
  updatePowerUI();
}

// advance level after boss defeated
function advanceLevel(){ // after boss defeated, increase difficulty by modifying enemy spawn behavior
  // small delay and then move to next
  time = 0; // reset time for next triggers
  // change enemy characteristics to be more aggressive depending on previous boss
  if(level === 1){ // after alien: enemies swarm faster
    // increase base speeds by small factor
  } else if(level === 2){ // after ptera: introduce more dive patterns
  } else if(level === 3){ // after t-rex: increase hp of grunts
  } else if(level === 4){ // after mecha: shooters more frequent
  }
  level = Math.min(level+1, 5);
  showLevelTitle('LEVEL ' + level);
  // spawn a few new enemies to fill the field
  for(let i=0;i<6 + level;i++) spawnEnemyVariant();
}

// drawing
function draw(){ ctx.clearRect(0,0,W,H);
  // background
  const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,`hsl(${(time*8)%360} 60% 6%)`); g.addColorStop(1,`hsl(${(time*8+80)%360} 70% 10%)`); ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // starfield
  for(let i=0;i<60;i++){ const x = ((i*97 + time*40)%W); const y = (i*53)%H; ctx.fillStyle = `hsl(${(i*7 + time*8)%360} 60% 55%)`; ctx.fillRect(x,y,2,2); }

  // shake
  if(shake>0){ ctx.save(); ctx.translate((Math.random()*2-1)*shake, (Math.random()*2-1)*shake); shake *= 0.92; }

  // powerups
  powerups.forEach(p=>{ const rad = 18 + Math.sin(time*8 + p.x)*3; ctx.save(); ctx.globalCompositeOperation='lighter'; const gr = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rad); gr.addColorStop(0,'rgba(255,255,255,0.9)'); gr.addColorStop(1,'rgba(0,150,255,0.0)'); ctx.fillStyle = gr; ctx.beginPath(); ctx.arc(p.x,p.y,rad,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // enemies
  enemies.forEach(e=>{ ctx.save(); ctx.globalCompositeOperation='lighter'; // color by pattern/level
    if(level<=2) ctx.fillStyle='hsl(10 90% 60%)'; else if(level===3) ctx.fillStyle='hsl(24 90% 60%)'; else if(level===4) ctx.fillStyle='hsl(200 90% 60%)'; else ctx.fillStyle='hsl(280 80% 60%)';
    // draw simple sprite by pattern
    if(e.pattern==='sine' || e.pattern==='dive' || e.pattern==='zigzag') ctx.fillRect(e.x-e.r,e.y-e.r,e.r*2,e.r*2);
    else ctx.beginPath(), ctx.arc(e.x,e.y,e.r,0,Math.PI*2), ctx.fill();
    ctx.restore(); });

  // boss
  if(boss){ ctx.save(); ctx.globalCompositeOperation='lighter'; // draw stylized boss shape based on type
    ctx.fillStyle = boss.color;
    if(boss.type==='alien'){ // weird organic shape
      drawAlienBoss(boss.x, boss.y);
    } else if(boss.type==='ptera'){
      drawPteraBoss(boss.x, boss.y);
    } else if(boss.type==='trex'){
      drawTrexBoss(boss.x, boss.y);
    } else if(boss.type==='mech'){
      drawMechaBoss(boss.x, boss.y);
    } else {
      drawOverlordBoss(boss.x, boss.y);
    }
    ctx.restore(); }

  // bullets
  player.bullets.forEach(b=>{
    if(b.type==='laser'){
      ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.fillStyle='rgba(160,240,255,0.9)'; ctx.fillRect(b.x-6,0,12,b.y); ctx.restore();
    } else {
      ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.fillStyle='rgba(180,240,255,1)'; ctx.fillRect(b.x-4,b.y-16,8,20); ctx.restore();
    }
  });

  // particles
  particles.forEach(p=>{ ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.fillStyle = `hsla(${p.hue},100%,60%,${p.alpha})`; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // player
  ctx.save(); ctx.globalCompositeOperation='lighter'; const pb = ctx.createLinearGradient(player.x,player.y-player.r,player.x,player.y+player.r); pb.addColorStop(0,'#6ff'); pb.addColorStop(1,'#08f'); ctx.fillStyle=pb; roundShip(player.x,player.y,player.r*1.4,player.r*1.8); ctx.fill(); ctx.restore();

  if(shake>0) ctx.restore();
}

// boss draw helpers (simple vector-ish shapes)
function drawAlienBoss(x,y){ ctx.beginPath(); ctx.ellipse(x,y,120,70,0,0,Math.PI*2); ctx.fill(); // body
  // eyes
  ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.beginPath(); ctx.arc(x-36,y-6,10,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+36,y-6,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle=boss.color; }
function drawPteraBoss(x,y){ ctx.beginPath(); ctx.moveTo(x-140,y); ctx.quadraticCurveTo(x-20,y-40,x,y-10); ctx.quadraticCurveTo(x+20,y-40,x+140,y); ctx.lineTo(x+40,y+40); ctx.lineTo(x-40,y+40); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.arc(x,y-6,26,0,Math.PI*2); ctx.fill(); }
function drawTrexBoss(x,y){ ctx.beginPath(); ctx.moveTo(x-120,y+30); ctx.quadraticCurveTo(x-60,y-120,x+20,y-40); ctx.quadraticCurveTo(x+80,y-10,x+120,y+30); ctx.lineTo(x+60,y+60); ctx.lineTo(x-60,y+60); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.arc(x-20,y-30,16,0,Math.PI*2); ctx.fill(); }
function drawMechaBoss(x,y){ // boxy
  ctx.fillRect(x-140,y-40,280,80); ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.fillRect(x-120,y-20,60,40); ctx.fillRect(x+60,y-20,60,40); ctx.fillStyle=boss.color; }
function drawOverlordBoss(x,y){ // layered alien
  ctx.beginPath(); ctx.ellipse(x,y,160,90,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(x,y+30,120,50,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x,y-40,28,0,Math.PI*2); ctx.fill(); }

function roundShip(cx,cy,w,h){ ctx.beginPath(); ctx.moveTo(cx-w*0.3,cy-h*0.5); ctx.quadraticCurveTo(cx,cy-h*0.8,cx+w*0.3,cy-h*0.5); ctx.lineTo(cx+w*0.35,cy+h*0.3); ctx.quadraticCurveTo(cx,cy+h*0.55,cx-w*0.35,cy+h*0.3); ctx.closePath(); }

function createExplosion(x,y){ for(let i=0;i<18;i++){ particles.push({x:x+rand(-8,8), y:y+rand(-8,8), vx:rand(-200,200), vy:rand(-200,200), alpha:1, size:rand(2,6), hue:rand(0,360)}); } navigator.vibrate?.(80); }

// level title display
function showLevelTitle(text){ const el = document.getElementById('levelTitle'); el.textContent = text; el.style.display='block'; showLevelTimer = 2.2; setTimeout(()=>{ el.style.display='none'; }, 1600); }

// main loop
let last = performance.now(); function main(now){ const dt = Math.min((now-last)/1000, 0.033); last = now; time += dt; update(dt); draw(); // level title timer fade
  if(showLevelTimer>0) showLevelTimer -= dt; requestAnimationFrame(main); }
requestAnimationFrame(main);

// spawn initial field
for(let i=0;i<6;i++) spawnEnemyVariant(); setTimeout(()=>{ for(let i=0;i<2;i++) spawnPower(rand(100,W-100), rand(150,H-300)); },1200);

// expose debug
window.spawnBoss = spawnBossByLevel; window.activatePower = activatePower;

</script>
</body>
</html>
